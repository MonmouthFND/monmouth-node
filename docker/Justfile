set dotenv-load := true

default:
    @just --list

build:
    docker buildx bake --allow=fs.read=.. -f docker-bake.hcl kora-local

build-fresh:
    docker buildx bake --allow=fs.read=.. -f docker-bake.hcl kora-local --no-cache

devnet: build _devnet-run

devnet-minimal: build
    @COMPOSE_PROFILES="" just _devnet-run

_devnet-run:
    #!/bin/bash
    set -e
    
    echo "Starting Kora Devnet..."
    echo "Chain ID: ${CHAIN_ID:-1337} | Validators: 4 | Threshold: 3"
    echo ""
    
    CONFIG_EXISTS=false
    SHARES_EXIST=false
    
    docker volume inspect kora-devnet_shared_config >/dev/null 2>&1 && \
        docker run --rm -v kora-devnet_shared_config:/shared alpine test -f /shared/peers.json && \
        CONFIG_EXISTS=true
    
    docker volume inspect kora-devnet_data_node0 >/dev/null 2>&1 && \
        docker run --rm -v kora-devnet_data_node0:/data alpine test -f /data/share.key && \
        SHARES_EXIST=true
    
    if [[ "$CONFIG_EXISTS" != "true" ]]; then
        echo "[Phase 0] Generating configuration..."
        docker compose -f compose/devnet.yaml run --rm init-config
    else
        echo "[Phase 0] Configuration exists"
    fi
    
    if [[ "$SHARES_EXIST" != "true" ]]; then
        echo ""
        echo "[Phase 1] Running interactive DKG ceremony..."
        docker compose -f compose/devnet.yaml up -d dkg-node0 dkg-node1 dkg-node2 dkg-node3
        
        echo "Waiting for DKG completion..."
        while true; do
            HEALTHY=$(docker compose -f compose/devnet.yaml ps --format json 2>/dev/null | \
                jq -r 'select(.Service | startswith("dkg-")) | select(.Health == "healthy") | .Service' | wc -l)
            [[ "$HEALTHY" -ge 4 ]] && break
            printf "."
            sleep 2
        done
        echo ""
        echo "[Phase 1] DKG ceremony complete"
        
        docker compose -f compose/devnet.yaml stop dkg-node0 dkg-node1 dkg-node2 dkg-node3
    else
        echo "[Phase 1] Threshold shares exist"
    fi
    
    echo ""
    echo "[Phase 2] Starting validators..."
    docker compose -f compose/devnet.yaml ${COMPOSE_PROFILES:+--profile observability} up -d \
        validator-node0 validator-node1 validator-node2 validator-node3 \
        ${COMPOSE_PROFILES:+prometheus grafana}
    
    echo ""
    just status

down:
    docker compose -f compose/devnet.yaml down

reset:
    docker compose -f compose/devnet.yaml down -v
    @echo "Devnet reset. Next 'just devnet' runs fresh DKG."

restart: down devnet

restart-validators:
    docker compose -f compose/devnet.yaml restart validator-node0 validator-node1 validator-node2 validator-node3

status:
    @echo ""
    @docker compose -f compose/devnet.yaml ps
    @echo ""
    @echo "Endpoints:"
    @echo "  P2P:        localhost:30400-30403"
    @echo "  RPC:        localhost:8540-8543 (disabled)"
    @echo "  Prometheus: http://localhost:9090"
    @echo "  Grafana:    http://localhost:3000"

logs:
    docker compose -f compose/devnet.yaml logs -f validator-node0 validator-node1 validator-node2 validator-node3

logs-dkg:
    docker compose -f compose/devnet.yaml logs -f dkg-node0 dkg-node1 dkg-node2 dkg-node3

logs-node node:
    docker compose -f compose/devnet.yaml logs -f {{node}}

exec node:
    docker compose -f compose/devnet.yaml exec {{node}} /bin/bash

redo-dkg:
    #!/bin/bash
    docker compose -f compose/devnet.yaml stop validator-node0 validator-node1 validator-node2 validator-node3
    
    for i in 0 1 2 3; do
        docker run --rm -v kora-devnet_data_node${i}:/data alpine rm -f /data/share.key /data/output.json
    done
    
    docker compose -f compose/devnet.yaml up -d dkg-node0 dkg-node1 dkg-node2 dkg-node3
    
    echo "Waiting for DKG..."
    while true; do
        HEALTHY=$(docker compose -f compose/devnet.yaml ps --format json 2>/dev/null | \
            jq -r 'select(.Service | startswith("dkg-")) | select(.Health == "healthy") | .Service' | wc -l)
        [[ "$HEALTHY" -ge 4 ]] && break
        sleep 2
    done
    
    docker compose -f compose/devnet.yaml stop dkg-node0 dkg-node1 dkg-node2 dkg-node3
    docker compose -f compose/devnet.yaml up -d validator-node0 validator-node1 validator-node2 validator-node3
    echo "DKG complete. Validators restarted."

lint:
    hadolint Dockerfile

validate:
    docker compose -f compose/devnet.yaml config --quiet && echo "Compose valid"
